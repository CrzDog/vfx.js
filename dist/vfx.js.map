{"version":3,"file":"vfx.js","sources":["../lib/effect.js","../lib/particle.js","../lib/emitter.js","../index.js"],"sourcesContent":["'use strict';\n\nexport default class Effect {\n  constructor() {\n    this._emitters = [];\n  }\n\n  setCamPos(pos) {\n    for (let i = 0; i < this._emitters.length; ++i) {\n      let emitter = this._emitters[i];\n      emitter._camPos = pos;\n    }\n  }\n\n  start () {\n    for (let i = 0; i < this._emitters.length; ++i) {\n      let emitter = this._emitters[i];\n      if (!emitter.disabled) {\n        emitter.tick();\n      }\n    }\n  }\n\n  tick(dt) {\n    for (let i = 0; i < this._emitters.length; ++i) {\n      let emitter = this._emitters[i];\n      if (!emitter.disabled) {\n        emitter.tick(dt);\n      }\n    }\n  }\n\n  addEmitter(emitter) {\n    if (this._emitters.indexOf(emitter) === -1) {\n      this._emitters.push(emitter);\n    }\n  }\n\n  removeEmitter(emitter) {\n    let idx = this._emitters.indexOf(emitter);\n    if (idx !== -1) {\n      this._emitters.splice(idx, 1);\n    }\n  }\n}","'use strict';\n\nimport { vec3 } from 'vmath';\n\nexport default class Particle {\n  constructor() {\n    this.life = 1.0;\n    this.velocity = vec3.new(0, 1, 0);\n\n    // internal state\n    this.age = 0.0;\n    this.position = vec3.new(0, 0, 0);\n    this._distanceToCam = 1;\n  }\n\n  reset () {\n    // internal state\n    this.age = 0.0;\n    vec3.set(this.position, 0, 0, 0);\n    this._distanceToCam = 1;\n  }\n}","'use strict';\n\nimport { randomRange, vec3 } from 'vmath';\nimport { RecyclePool } from 'memop';\nimport Particle from './particle';\n\nexport default class Emitter {\n  constructor() {\n    this.emitRate = 10; // number of particles emitted per spawn metric (per second, per world unit, ...)\n    this.maxParticles = 0; // the total number of particles the emitter will emit (if available, otherwise zero)\n\n    // internal states\n    this.disabled = true;\n    this.age = 0.0;\n    this.emittedCount = 0; // number of particles already emitted\n\n    this._nextEmits = 0.0;\n    this._particles = new RecyclePool(function () {\n      return new Particle();\n    }, 100);\n\n    this._camPos = null;\n  }\n\n  start() {\n    if (!this.disabled) {\n      return;\n    }\n\n    this.disabled = false;\n  }\n\n  stop() {\n    if (this.disabled) {\n      return;\n    }\n\n    this.age = 0.0;\n    this.disabled = true;\n  }\n\n  tick(dt) {\n    if (this.disabled) {\n      return;\n    }\n\n    this.age += dt;\n\n    // update exists particles\n    for (let i = 0; i < this._particles.length; ++i) {\n      let p = this._particles.data[i];\n      p.age += dt;\n\n      if (p.age >= p.life) {\n        p.reset();\n        this._particles.remove(i);\n        --i;\n        continue;\n      }\n\n      vec3.scaleAndAdd(p.position, p.position, p.velocity, dt);\n\n      // calculate sorting\n      if (this._camPos) {\n        p._distanceToCam = -vec3.squaredDistance(p.position, this._camPos);\n      }\n    }\n\n    // check if spawn new particle\n    this._nextEmits += this.emitRate * dt;\n    if (this._nextEmits >= 1) {\n      let spawns = Math.floor(this._nextEmits);\n      this._nextEmits -= spawns;\n\n      while (spawns > 0) {\n        let p = this._particles.add();\n        this.emittedCount += 1;\n\n        vec3.random(p.velocity, randomRange(0.1, 10));\n        p.life = randomRange(1,10);\n\n        // calculate sorting\n        if (this._camPos) {\n          p._distanceToCam = -vec3.squaredDistance(p.position, this._camPos);\n        }\n\n        --spawns;\n      }\n    }\n\n    if (this._camPos) {\n      // NOTE: javascript not support partially sort\n      this._particles._data.sort((a, b) => {\n        return a._distanceToCam - b._distanceToCam;\n      });\n    }\n  }\n}","'use strict';\n\nimport Effect from './lib/effect';\nimport Emitter from './lib/emitter';\n\nexport default {\n  Effect,\n  Emitter,\n};"],"names":["vec3","RecyclePool","randomRange"],"mappings":"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"}